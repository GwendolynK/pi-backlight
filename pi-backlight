#!/usr/bin/perl
#
# Created bt: Westley K
# Email: westley@sylabs.io
# Date Jul 12, 2018
# https://github.com/WestleyK/pi-backlight
# Version-1.2


$VERSION_SCRIPT = "version-1.2\n";

$FILE_BRIGHT = "/tmp/backlight_brightness.txt";
$FILE_DISP_ON = "/tmp/backlight_power.txt";
$FILE_CURRENT = "/sys/class/backlight/rpi_backlight/brightness";
$STEP_UP = "30";
$STEP_DOWN = "30";

$OPTION = "$ARGV[0]\n";
$ONE_OPTION = "$ARGV[1]";


if ($ONE_OPTION ne "") {
	print "Only one argument!\n";
	print "Try: pi-backlight -help\n";
	exit
}

if ($OPTION ne "\n") {
	
	if ($OPTION eq "-h\n" || $OPTION eq "-help\n" || $OPTION eq "--help\n") {
		$OPT_H = "true";
	} elsif ($OPTION eq "-u\n" || $OPTION eq "-up\n") {
		$OPT_U = "true";
	} elsif ($OPTION eq "-d\n" || $OPTION eq "-down\n") {
		$OPT_D = "true";
	} elsif ($OPTION eq "-s\n" || $OPTION eq "-sleep\n") {
		$OPT_S = "true"
	} elsif ($OPTION eq "-c\n") {
		$OPT_C = "true";
	} elsif ($OPTION eq "-n\n" || $OPTION eq "-on\n") {
		$OPT_N = "true";
	} elsif ($OPTION eq "-v\n" || $OPTION eq "-version\n" || $OPTION eq "--version\n") {
		$OPT_V = "true";
	} elsif ($OPTION =~ /[0-9]/) {
		$ADJ = "true";
		$BRIGHT = $OPTION;
	} else {
		print "Option not found!\n";
		print "Try: pi-backlight -help\n";
		exit;
	}


}


if ($OPT_H eq "true") {
	print "Usage: pi-backlight [option]
	-h | -help | --help (print help menu)
	15-255 (adjust from 15 to 255)
	-u | -up (brighter by 30)
	-d | -down (lower by 30)
	-s | -sleep (enter sleep mode)
	-c (print currnt brightness, scale:[15-255])
	-n | -on (turns backlight on to 200)
	-v | -version | --version (print version)\n";
	exit;
}

if ($OPT_U eq "true") {
	open(my $CURRENT_BRIGHTNESS, '<', $FILE_CURRENT);
	$CONTENT = <$CURRENT_BRIGHTNESS>;
	close($CURRENT_BRIGHTNESS);
	$CONTENT += $STEP_UP;
	if ($CONTENT >= 255) {
		print("Max brightness!\n");
		$CONTENT = 255;
		open($LIGHT_FILE, '>', $FILE_BRIGHT);
		print $LIGHT_FILE $CONTENT;
		close $LIGHT_FILE;
		print("Current brightness: $CONTENT\n");
		system("sudo bash -c 'cat /tmp/backlight_brightness.txt > /sys/class/backlight/rpi_backlight/brightness'");
		exit;
	}
	open($LIGHT_FILE, '>', $FILE_BRIGHT);
	print $LIGHT_FILE $CONTENT;
	close $LIGHT_FILE;
	print("Current brightness: $CONTENT\n");
	system("sudo bash -c 'cat /tmp/backlight_brightness.txt > /sys/class/backlight/rpi_backlight/brightness'");
	exit;
}

if ($OPT_D eq "true") {
	open(my $CURRENT_BRIGHTNESS, '<', $FILE_CURRENT);
	$CONTENT = <$CURRENT_BRIGHTNESS>;
	close($CURRENT_BRIGHTNESS);
	$CONTENT -= $STEP_DOWN;
	if ($CONTENT <= 15) {
		print("Min brightness!\n");
		$CONTENT = 15;
		open($LIGHT_FILE, '>', $FILE_BRIGHT);
		print $LIGHT_FILE $CONTENT;
		close $LIGHT_FILE;
		print("Current brightness: $CONTENT\n");
		system("sudo bash -c 'cat /tmp/backlight_brightness.txt > /sys/class/backlight/rpi_backlight/brightness'");
		exit;
	}
	open($LIGHT_FILE, '>', $FILE_BRIGHT);
	print $LIGHT_FILE $CONTENT;
	close $LIGHT_FILE;
	print("Current brightness: $CONTENT\n");
	system("sudo bash -c 'cat /tmp/backlight_brightness.txt > /sys/class/backlight/rpi_backlight/brightness'");
	exit;

}

if ($OPT_S eq "true") {
	print "Press enter to exit this mode.\n";
	sleep(2);
	system("sudo bash -c 'echo 1 > /sys/class/backlight/rpi_backlight/bl_power'");
	$STOP = <STDIN>;
	system("sudo bash -c 'echo 0 > /sys/class/backlight/rpi_backlight/bl_power'");
	exit;
}

if ($OPT_C eq "true") {
	print "Scale:[15-255]:\n";
	system("cat /sys/class/backlight/rpi_backlight/brightness");
	exit;
}

if ($OPT_N eq "true") {
	system("sudo bash -c 'echo 0 > /sys/class/backlight/rpi_backlight/bl_power'");
	system("sudo bash -c 'echo 200 > /sys/class/backlight/rpi_backlight/brightness'");
	exit;
}

if ($OPT_V eq "true") {
	print $VERSION_SCRIPT;
	exit;
}

if ($ADJ eq "true") {
	if (($BRIGHT >= 15) && ($BRIGHT <= 255)) {
		open($LIGHT_FILE, '>', $FILE_BRIGHT);
		print $LIGHT_FILE $BRIGHT;
		close $LIGHT_FILE;
		system("sudo bash -c 'cat /tmp/backlight_brightness.txt > /sys/class/backlight/rpi_backlight/brightness'");
		exit;
	} else {
		print "Not a valid number\n";
		exit;
	}
}

print "[15-255]:";
$BRIGHT = <STDIN>;
if (($BRIGHT >= 15) && ($BRIGHT <= 255)) {
	open($LIGHT_FILE, '>', $FILE_BRIGHT);
	print $LIGHT_FILE $BRIGHT;
	close $LIGHT_FILE;
	system("sudo bash -c 'cat /tmp/backlight_brightness.txt > /sys/class/backlight/rpi_backlight/brightness'");
} else {
	print "Not a valid number!\n";
	exit;
}




#
# End Perl Script;
#



